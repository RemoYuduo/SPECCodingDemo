# 企业内部福利商城 - 协议和数据

|- **版本**: v1.0.0
|- **更新日期**: 2025-12-15
|- **API版本**: v1.0
|- **数据库版本**: v1.0
|- **状态**: 开发中

## 前后端API协议

### 统一响应格式

所有API接口都遵循统一的响应格式：

```json
{
  "success": boolean,
  "message": "string",
  "data": object || array,
  "error": {
    "code": "string",
    "message": "string",
    "details": "string"
  },
  "timestamp": "ISO8601格式时间戳"
}
```

### 错误码定义

| 错误码 | HTTP状态码 | 描述 |
|--------|-----------|------|
| AUTH_001 | 401 | 未授权访问 |
| AUTH_002 | 401 | Token已过期 |
| AUTH_003 | 401 | Token无效 |
| AUTH_004 | 403 | 权限不足 |
| USER_001 | 400 | 用户名或密码错误 |
| USER_002 | 404 | 用户不存在 |
| USER_003 | 409 | 用户名已存在 |
| PROD_001 | 404 | 商品不存在 |
| PROD_002 | 400 | 商品库存不足 |
| CART_001 | 400 | 购物车为空 |
| ORDER_001 | 400 | 创建订单失败 |
| ORDER_002 | 404 | 订单不存在 |
| SYS_001 | 500 | 系统内部错误 |
| SYS_002 | 503 | 服务暂不可用 |

### 健康检查相关API

#### 服务健康检查
```http
GET /api/health

Response:
{
  "success": true,
  "message": "服务运行正常",
  "data": {
    "status": "healthy",
    "timestamp": "2025-12-15T10:00:00Z",
    "uptime": 3600,
    "database": {
      "status": "connected",
      "responseTime": 5
    },
    "services": {
      "api": "running",
      "database": "connected"
    }
  }
}
```

#### 数据库状态检查
```http
GET /api/health/database

Response:
{
  "success": true,
  "message": "数据库状态正常",
  "data": {
    "status": "connected",
    "tables": {
      "users": 4,
      "products": 20,
      "orders": 15,
      "order_items": 35,
      "cart": 10,
      "points_history": 50,
      "categories": 5,
      "addresses": 8
    },
    "responseTime": 5
  }
}
```

### 认证相关API

#### 用户登录
```http
POST /api/auth/login
Content-Type: application/json

Request Body:
{
  "username": "string",
  "password": "string",
  "type": "user|admin"
}

Response:
{
  "success": true,
  "message": "登录成功",
  "data": {
    "token": "jwt_token_string",
    "refreshToken": "refresh_token_string",
    "userType": "user|admin",
    "userId": 1,
    "username": "user1",
    "expiresIn": 3600
  }
}

错误响应:
{
  "success": false,
  "error": {
    "code": "USER_001",
    "message": "用户名或密码错误"
  }
}
```

#### 用户登出
```http
POST /api/auth/logout
Authorization: Bearer <token>
Content-Type: application/json

Response:
{
  "success": true,
  "message": "登出成功"
}
```

#### 管理员登录
```http
POST /api/admin/login
Content-Type: application/json

Request Body:
{
  "username": "admin",
  "password": "admin123"
}

Response:
{
  "success": true,
  "message": "管理员登录成功",
  "data": {
    "token": "jwt_token_string",
    "admin": {
      "id": 4,
      "username": "admin",
      "role": "admin"
    },
    "expiresIn": 3600
  }
}
```

### 管理员相关API

#### 获取系统状态
```http
GET /api/admin/system-status
Authorization: Bearer <admin_token>

Response:
{
  "success": true,
  "message": "系统状态正常",
  "data": {
    "status": "healthy",
    "version": "1.0.0",
    "uptime": 86400,
    "statistics": {
      "users": {
        "total": 100,
        "active": 80,
        "new": 5
      },
      "products": {
        "total": 50,
        "active": 45,
        "outOfStock": 5
      },
      "orders": {
        "total": 200,
        "pending": 10,
        "completed": 180,
        "cancelled": 10
      },
      "points": {
        "totalIssued": 10000,
        "totalSpent": 5000,
        "currentBalance": 5000
      }
    },
    "timestamp": "2025-12-15T10:00:00Z"
  }
}
```

#### 商品管理
```http
GET /api/admin/products?page=1&limit=10&status=active&category=1
Authorization: Bearer <admin_token>

Response:
{
  "success": true,
  "data": {
    "products": [
      {
        "id": 1,
        "name": "智能手机",
        "description": "高性能智能手机",
        "price": 1999.00,
        "pointsRequired": 100,
        "stock": 50,
        "images": [
          "/uploads/products/compressed_xxx.jpg",
          "/uploads/products/compressed_yyy.jpg"
        ],
        "status": "active",
        "category": {
          "id": 1,
          "name": "电子产品"
        },
        "sales": 20,
        "createdAt": "2025-12-15T10:00:00Z",
        "updatedAt": "2025-12-15T10:00:00Z"
      }
    ],
    "pagination": {
      "page": 1,
      "limit": 10,
      "total": 50,
      "totalPages": 5
    }
  }
}
```

#### 商品图片上传
```http
POST /api/admin/products/upload-image
Authorization: Bearer <admin_token>
Content-Type: multipart/form-data

Request Body:
image: File

Response:
{
  "success": true,
  "message": "图片上传成功",
  "data": {
    "filename": "compressed_xxx.jpg",
    "url": "/uploads/products/compressed_xxx.jpg",
    "size": 102400
  }
}
```

#### 商品分类管理
```http
GET /api/admin/categories
Authorization: Bearer <admin_token>

Response:
{
  "success": true,
  "data": [
    {
      "id": 1,
      "name": "电子产品",
      "description": "各类电子设备",
      "sort": 1,
      "status": "active",
      "productCount": 15
    }
  ]
}
```

## 数据库设计

### 数据库设计原则

1. 使用SQLite作为数据库
2. 表名使用复数形式，字段名使用下划线命名法
3. 主键使用自增整数id，外键使用相应表名_id
4. 创建时间字段名为created_at，更新时间字段名为updated_at
5. 软删除使用deleted_at字段
6. 状态字段使用枚举值字符串
7. 金额/积分字段使用整数类型，避免浮点数精度问题

### 用户表 (users)
```sql
CREATE TABLE users (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  username TEXT UNIQUE NOT NULL,
  password TEXT NOT NULL,
  email TEXT,
  phone TEXT,
  points INTEGER DEFAULT 0,
  role TEXT DEFAULT 'user', -- 'user' or 'admin'
  department TEXT,
  position TEXT,
  avatar TEXT,
  status TEXT DEFAULT 'active', -- 'active' or 'inactive'
  last_login_at DATETIME,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  deleted_at DATETIME
);

-- 索引
CREATE UNIQUE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_role ON users(role);
CREATE INDEX idx_users_status ON users(status);
CREATE INDEX idx_users_created_at ON users(created_at);

-- 初始测试数据
INSERT INTO users (username, password, email, points, role, department, position) VALUES
('user1', '$2b$10$rOzJqQZQZQZQZQZQZQZOzJqQZQZQZQZQZQZQZQZQZQZQZQ', 'user1@example.com', 100, 'user', '技术部', '软件工程师'),
('user2', '$2b$10$rOzJqQZQZQZQZQZQZQZOzJqQZQZQZQZQZQZQZQZQ', 'user2@example.com', 200, 'user', '市场部', '市场专员'),
('user3', '$2b$10$rOzJqQZQZQZQZQZQZQZOzJqQZQZQZQZQZQZQZQ', 'user3@example.com', 150, 'user', '人事部', '人事专员'),
('admin', '$2b$10$rOzJqQZQZQZQZQZQZQZOzJqQZQZQZQZQZQZQZQZQ', 'admin@example.com', 0, 'admin', 'IT部', '系统管理员');
```

### 商品分类表 (categories)
```sql
CREATE TABLE categories (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  name TEXT NOT NULL,
  description TEXT,
  sort INTEGER DEFAULT 0,
  icon TEXT,
  status TEXT DEFAULT 'active', -- 'active' or 'inactive'
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  deleted_at DATETIME
);

-- 索引
CREATE INDEX idx_categories_sort ON categories(sort);
CREATE INDEX idx_categories_status ON categories(status);

-- 初始数据
INSERT INTO categories (name, description, sort) VALUES
('电子产品', '各类电子设备', 1),
('生活用品', '日常生活用品', 2),
('办公用品', '办公相关用品', 3),
('运动健康', '运动健康相关产品', 4),
('图书音像', '图书和音像制品', 5);
```

### 商品表 (products)
```sql
CREATE TABLE products (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  name TEXT NOT NULL,
  description TEXT,
  specifications TEXT, -- JSON格式存储规格参数
  price REAL NOT NULL,
  points_required INTEGER NOT NULL,
  stock INTEGER DEFAULT 0,
  warning_stock INTEGER DEFAULT 10,
  images TEXT, -- JSON格式存储图片URL数组
  status TEXT DEFAULT 'active', -- 'active' or 'inactive'
  category_id INTEGER,
  sales INTEGER DEFAULT 0,
  views INTEGER DEFAULT 0,
  favorites INTEGER DEFAULT 0,
  exchange_rules TEXT, -- 兑换规则
  sort INTEGER DEFAULT 0,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  deleted_at DATETIME,
  FOREIGN KEY (category_id) REFERENCES categories (id)
);

-- 索引
CREATE INDEX idx_products_category_id ON products(category_id);
CREATE INDEX idx_products_status ON products(status);
CREATE INDEX idx_products_points_required ON products(points_required);
CREATE INDEX idx_products_sales ON products(sales);
CREATE INDEX idx_products_sort ON products(sort);
CREATE INDEX idx_products_created_at ON products(created_at);
```

### 图片存储设计

- 上传路径: `/uploads/products/`
- 文件命名: `compressed_${uuid}.jpg`
- URL格式: `/uploads/products/compressed_${uuid}.jpg`
- 图片处理: 使用Sharp进行压缩，默认宽800px，高600px，质量80%
- 存储方式: 数据库中存储JSON格式的URL数组