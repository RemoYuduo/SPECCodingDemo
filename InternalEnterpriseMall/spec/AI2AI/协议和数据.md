# 企业内部福利商城 - 协议和数据

- **版本**: v1.0.0
- **更新日期**: 2023-12-15
- **API版本**: v1.0
- **数据库版本**: v1.0
- **状态**: 开发中

## 前后端API协议

### 统一响应格式

所有API接口都遵循统一的响应格式：

```json
{
  "success": boolean,
  "message": "string",
  "data": object || array,
  "error": {
    "code": "string",
    "message": "string",
    "details": "string"
  },
  "timestamp": "ISO8601格式时间戳"
}
```

### 错误码定义

| 错误码 | HTTP状态码 | 描述 |
|--------|-----------|------|
| AUTH_001 | 401 | 未授权访问 |
| AUTH_002 | 401 | Token已过期 |
| AUTH_003 | 401 | Token无效 |
| AUTH_004 | 403 | 权限不足 |
| USER_001 | 400 | 用户名或密码错误 |
| USER_002 | 404 | 用户不存在 |
| USER_003 | 409 | 用户名已存在 |
| PROD_001 | 404 | 商品不存在 |
| PROD_002 | 400 | 商品库存不足 |
| CART_001 | 400 | 购物车为空 |
| ORDER_001 | 400 | 创建订单失败 |
| ORDER_002 | 404 | 订单不存在 |
| SYS_001 | 500 | 系统内部错误 |
| SYS_002 | 503 | 服务暂不可用 |

### 健康检查相关API

#### 服务健康检查
```http
GET /api/health

Response:
{
  "success": true,
  "message": "服务运行正常",
  "data": {
    "status": "healthy",
    "timestamp": "2023-12-15T10:00:00Z",
    "uptime": 3600,
    "database": {
      "status": "connected",
      "responseTime": 5
    },
    "services": {
      "api": "running",
      "database": "connected"
    }
  }
}
```

#### 数据库状态检查
```http
GET /api/health/database

Response:
{
  "success": true,
  "message": "数据库状态正常",
  "data": {
    "status": "connected",
    "tables": {
      "users": 4,
      "products": 20,
      "orders": 15,
      "order_items": 35,
      "cart": 10,
      "points_history": 50,
      "categories": 5,
      "addresses": 8
    },
    "responseTime": 5
  }
}
```

### 认证相关API

#### 用户登录
```http
POST /api/auth/login
Content-Type: application/json

Request Body:
{
  "username": "string",
  "password": "string",
  "type": "user|admin"
}

Response:
{
  "success": true,
  "message": "登录成功",
  "data": {
    "token": "jwt_token_string",
    "refreshToken": "refresh_token_string",
    "userType": "user|admin",
    "userId": 1,
    "username": "user1",
    "expiresIn": 3600
  }
}

错误响应:
{
  "success": false,
  "error": {
    "code": "USER_001",
    "message": "用户名或密码错误"
  }
}
```

#### 用户登出
```http
POST /api/auth/logout
Authorization: Bearer <token>
Content-Type: application/json

Response:
{
  "success": true,
  "message": "登出成功"
}
```

#### 刷新Token
```http
POST /api/auth/refresh
Content-Type: application/json

Request Body:
{
  "refreshToken": "string"
}

Response:
{
  "success": true,
  "message": "Token刷新成功",
  "data": {
    "token": "new_jwt_token_string",
    "expiresIn": 3600
  }
}
```

### 用户相关API

#### 获取用户信息
```http
GET /api/user/profile
Authorization: Bearer <token>

Response:
{
  "success": true,
  "data": {
    "id": 1,
    "username": "user1",
    "email": "user1@example.com",
    "phone": "13800138000",
    "points": 100,
    "role": "user",
    "department": "技术部",
    "position": "软件工程师",
    "avatar": "avatar_url",
    "created_at": "2023-01-01T00:00:00Z",
    "updated_at": "2023-12-01T00:00:00Z"
  }
}
```

#### 更新用户信息
```http
PUT /api/user/profile
Authorization: Bearer <token>
Content-Type: application/json

Request Body:
{
  "email": "string",
  "phone": "string",
  "department": "string",
  "position": "string"
}

Response:
{
  "success": true,
  "message": "用户信息更新成功",
  "data": "更新后的用户信息"
}
```

#### 上传用户头像
```http
POST /api/user/avatar
Authorization: Bearer <token>
Content-Type: multipart/form-data

Request Body:
avatar: File

Response:
{
  "success": true,
  "message": "头像上传成功",
  "data": {
    "avatarUrl": "avatar_url"
  }
}
```

#### 修改密码
```http
PUT /api/user/password
Authorization: Bearer <token>
Content-Type: application/json

Request Body:
{
  "oldPassword": "string",
  "newPassword": "string"
}

Response:
{
  "success": true,
  "message": "密码修改成功"
}
```

#### 获取积分记录
```http
GET /api/user/points?page=1&limit=10&type=all
Authorization: Bearer <token>
type: earn|spend|all

Response:
{
  "success": true,
  "data": {
    "currentPoints": 100,
    "records": [
      {
        "id": 1,
        "pointsChange": 10,
        "type": "earn",
        "description": "签到奖励",
        "referenceId": null,
        "createdAt": "2023-12-15T10:00:00Z"
      },
      {
        "id": 2,
        "pointsChange": -50,
        "type": "spend",
        "description": "兑换商品",
        "referenceId": "order_uuid",
        "createdAt": "2023-12-14T10:00:00Z"
      }
    ],
    "pagination": {
      "page": 1,
      "limit": 10,
      "total": 50
    }
  }
}
```

#### 签到获取积分
```http
POST /api/user/checkin
Authorization: Bearer <token>

Response:
{
  "success": true,
  "message": "签到成功，获得10积分",
  "data": {
    "pointsEarned": 10,
    "currentPoints": 110
  }
}
```

#### 收货地址管理
```http
GET /api/user/addresses
Authorization: Bearer <token>

Response:
{
  "success": true,
  "data": [
    {
      "id": 1,
      "recipientName": "张三",
      "phone": "13800138000",
      "province": "北京市",
      "city": "北京市",
      "district": "朝阳区",
      "address": "某某街道123号",
      "isDefault": true,
      "createdAt": "2023-01-01T00:00:00Z"
    }
  ]
}

POST /api/user/addresses
Authorization: Bearer <token>
Content-Type: application/json

Request Body:
{
  "recipientName": "string",
  "phone": "string",
  "province": "string",
  "city": "string",
  "district": "string",
  "address": "string",
  "isDefault": boolean
}

Response:
{
  "success": true,
  "message": "收货地址添加成功",
  "data": "新增的地址信息"
}
```

### 商品相关API

#### 获取商品分类
```http
GET /api/products/categories

Response:
{
  "success": true,
  "data": [
    {
      "id": 1,
      "name": "电子产品",
      "description": "各类电子设备",
      "sort": 1
    },
    {
      "id": 2,
      "name": "生活用品",
      "description": "日常生活用品",
      "sort": 2
    }
  ]
}
```

#### 获取商品列表
```http
GET /api/products?page=1&limit=10&category=1&sort=points_asc&keyword=手机

Query Parameters:
- page: 页码，默认1
- limit: 每页数量，默认10
- category: 分类ID，可选
- sort: 排序方式，可选值：points_asc(积分升序)、points_desc(积分降序)、created_asc(创建时间升序)、created_desc(创建时间降序)
- keyword: 搜索关键词，可选

Response:
{
  "success": true,
  "data": {
    "products": [
      {
        "id": 1,
        "name": "智能手机",
        "description": "高性能智能手机",
        "price": 1999.00,
        "pointsRequired": 100,
        "stock": 50,
        "image": "product_image_url",
        "status": "active",
        "category": {
          "id": 1,
          "name": "电子产品"
        },
        "sales": 20,
        "isFavorite": false,
        "createdAt": "2023-01-01T00:00:00Z",
        "updatedAt": "2023-12-01T00:00:00Z"
      }
    ],
    "pagination": {
      "page": 1,
      "limit": 10,
      "total": 100,
      "totalPages": 10
    },
    "filters": {
      "categories": [
        {
          "id": 1,
          "name": "电子产品",
          "count": 50
        }
      ]
    }
  }
}
```

#### 获取商品详情
```http
GET /api/products/:id

Response:
{
  "success": true,
  "data": {
    "id": 1,
    "name": "智能手机",
    "description": "高性能智能手机，拥有优秀的拍照功能和长续航",
    "specifications": {
      "screen": "6.5英寸",
      "cpu": "八核处理器",
      "ram": "8GB",
      "storage": "128GB",
      "camera": "4800万像素"
    },
    "price": 1999.00,
    "pointsRequired": 100,
    "stock": 50,
    "images": [
      "image1_url",
      "image2_url"
    ],
    "status": "active",
    "category": {
      "id": 1,
      "name": "电子产品"
    },
    "sales": 20,
    "isFavorite": false,
    "exchangeRules": "每人限兑1台",
    "createdAt": "2023-01-01T00:00:00Z",
    "updatedAt": "2023-12-01T00:00:00Z"
  }
}
```

#### 商品收藏
```http
POST /api/products/:id/favorite
Authorization: Bearer <token>

Response:
{
  "success": true,
  "message": "收藏成功"
}

DELETE /api/products/:id/favorite
Authorization: Bearer <token>

Response:
{
  "success": true,
  "message": "取消收藏成功"
}

GET /api/products/favorites?page=1&limit=10
Authorization: Bearer <token>

Response:
{
  "success": true,
  "data": {
    "products": [
      {
        "id": 1,
        "name": "智能手机",
        "pointsRequired": 100,
        "image": "product_image_url",
        "status": "active"
      }
    ],
    "pagination": {
      "page": 1,
      "limit": 10,
      "total": 5,
      "totalPages": 1
    }
  }
}
```

### 购物车相关API

#### 添加商品到购物车
```http
POST /api/cart
Authorization: Bearer <token>
Content-Type: application/json

Request Body:
{
  "productId": 1,
  "quantity": 2
}

Response:
{
  "success": true,
  "message": "添加到购物车成功",
  "data": {
    "id": 1,
    "productId": 1,
    "productName": "智能手机",
    "quantity": 2,
    "pointsRequired": 100,
    "totalPoints": 200,
    "stock": 50
  }
}
```

#### 获取购物车
```http
GET /api/cart
Authorization: Bearer <token>

Response:
{
  "success": true,
  "data": {
    "items": [
      {
        "id": 1,
        "productId": 1,
        "productName": "智能手机",
        "productImage": "product_image_url",
        "quantity": 2,
        "pointsRequired": 100,
        "totalPoints": 200,
        "stock": 50,
        "isSelected": true,
        "createdAt": "2023-12-15T10:00:00Z"
      }
    ],
    "totalPoints": 200,
    "selectedPoints": 200,
    "totalItems": 2
  }
}
```

#### 更新购物车商品数量
```http
PUT /api/cart/:itemId
Authorization: Bearer <token>
Content-Type: application/json

Request Body:
{
  "quantity": 1
}

Response:
{
  "success": true,
  "message": "购物车更新成功",
  "data": {
    "id": 1,
    "quantity": 1,
    "totalPoints": 100
  }
}
```

#### 选择/取消选择购物车商品
```http
PUT /api/cart/:itemId/select
Authorization: Bearer <token>
Content-Type: application/json

Request Body:
{
  "isSelected": true
}

Response:
{
  "success": true,
  "message": "选择状态更新成功"
}
```

#### 删除购物车商品
```http
DELETE /api/cart/:itemId
Authorization: Bearer <token>

Response:
{
  "success": true,
  "message": "商品已从购物车移除"
}
```

#### 批量选择购物车商品
```http
PUT /api/cart/select-all
Authorization: Bearer <token>
Content-Type: application/json

Request Body:
{
  "isSelected": true
}

Response:
{
  "success": true,
  "message": "批量选择成功",
  "data": {
    "selectedCount": 3,
    "selectedPoints": 300
  }
}
```

#### 清空购物车
```http
DELETE /api/cart
Authorization: Bearer <token>

Response:
{
  "success": true,
  "message": "购物车已清空"
}
```

### 订单相关API

#### 创建订单
```http
POST /api/orders
Authorization: Bearer <token>
Content-Type: application/json

Request Body:
{
  "items": [
    {
      "productId": 1,
      "quantity": 2
    }
  ],
  "addressId": 1,
  "remark": "备注信息"
}

Response:
{
  "success": true,
  "message": "订单创建成功",
  "data": {
    "orderId": "order_uuid",
    "totalPoints": 200,
    "status": "pending",
    "createdAt": "2023-12-15T10:00:00Z"
  }
}
```

#### 获取订单列表
```http
GET /api/orders?page=1&limit=10&status=pending&startDate=2023-12-01&endDate=2023-12-31
Authorization: Bearer <token>

Query Parameters:
- page: 页码，默认1
- limit: 每页数量，默认10
- status: 订单状态，可选值：pending(待处理)、processing(处理中)、shipped(已发货)、completed(已完成)、cancelled(已取消)
- startDate: 开始日期，格式YYYY-MM-DD
- endDate: 结束日期，格式YYYY-MM-DD

Response:
{
  "success": true,
  "data": {
    "orders": [
      {
        "id": "order_uuid",
        "status": "pending",
        "statusText": "待处理",
        "totalPoints": 200,
        "shippingAddress": "收货地址信息",
        "items": [
          {
            "productId": 1,
            "productName": "智能手机",
            "productImage": "product_image_url",
            "quantity": 2,
            "pointsRequired": 100
          }
        ],
        "createdAt": "2023-12-15T10:00:00Z",
        "updatedAt": "2023-12-15T10:00:00Z"
      }
    ],
    "pagination": {
      "page": 1,
      "limit": 10,
      "total": 20,
      "totalPages": 2
    }
  }
}
```

#### 获取订单详情
```http
GET /api/orders/:id
Authorization: Bearer <token>

Response:
{
  "success": true,
  "data": {
    "id": "order_uuid",
    "status": "pending",
    "statusText": "待处理",
    "totalPoints": 200,
    "shippingAddress": {
      "recipientName": "张三",
      "phone": "13800138000",
      "address": "北京市朝阳区某某街道123号"
    },
    "remark": "备注信息",
    "items": [
      {
        "productId": 1,
        "productName": "智能手机",
        "productImage": "product_image_url",
        "quantity": 2,
        "pointsRequired": 100,
        "totalPoints": 200
      }
    ],
    "timeline": [
      {
        "status": "pending",
        "statusText": "订单已提交",
        "timestamp": "2023-12-15T10:00:00Z",
        "description": "您的订单已成功提交，等待管理员处理"
      }
    ],
    "createdAt": "2023-12-15T10:00:00Z",
    "updatedAt": "2023-12-15T10:00:00Z"
  }
}
```

#### 取消订单
```http
PUT /api/orders/:id/cancel
Authorization: Bearer <token>
Content-Type: application/json

Request Body:
{
  "reason": "取消原因"
}

Response:
{
  "success": true,
  "message": "订单取消成功，积分已返还",
  "data": {
    "orderId": "order_uuid",
    "status": "cancelled",
    "refundPoints": 200
  }
}
```

### 管理员相关API

#### 管理员登录
```http
POST /api/admin/login
Content-Type: application/json

Request Body:
{
  "username": "admin",
  "password": "admin123"
}

Response:
{
  "success": true,
  "message": "管理员登录成功",
  "data": {
    "token": "jwt_token_string",
    "admin": {
      "id": 4,
      "username": "admin",
      "role": "admin"
    },
    "expiresIn": 3600
  }
}
```

#### 获取系统状态
```http
GET /api/admin/system-status
Authorization: Bearer <admin_token>

Response:
{
  "success": true,
  "message": "系统状态正常",
  "data": {
    "status": "healthy",
    "version": "1.0.0",
    "uptime": 86400,
    "statistics": {
      "users": {
        "total": 100,
        "active": 80,
        "new": 5
      },
      "products": {
        "total": 50,
        "active": 45,
        "outOfStock": 5
      },
      "orders": {
        "total": 200,
        "pending": 10,
        "completed": 180,
        "cancelled": 10
      },
      "points": {
        "totalIssued": 10000,
        "totalSpent": 5000,
        "currentBalance": 5000
      }
    },
    "timestamp": "2023-12-15T10:00:00Z"
  }
}
```

#### 商品管理
```http
GET /api/admin/products?page=1&limit=10&status=active&category=1
Authorization: Bearer <admin_token>

Response:
{
  "success": true,
  "data": {
    "products": [
      {
        "id": 1,
        "name": "智能手机",
        "description": "高性能智能手机",
        "price": 1999.00,
        "pointsRequired": 100,
        "stock": 50,
        "image": "product_image_url",
        "status": "active",
        "category": {
          "id": 1,
          "name": "电子产品"
        },
        "sales": 20,
        "createdAt": "2023-01-01T00:00:00Z"
      }
    ],
    "pagination": {
      "page": 1,
      "limit": 10,
      "total": 50,
      "totalPages": 5
    }
  }
}

POST /api/admin/products
Authorization: Bearer <admin_token>
Content-Type: application/json

Request Body:
{
  "name": "新产品",
  "description": "产品描述",
  "price": 999.00,
  "pointsRequired": 50,
  "stock": 100,
  "categoryId": 1,
  "specifications": {
    "key1": "value1",
    "key2": "value2"
  },
  "exchangeRules": "兑换规则"
}

Response:
{
  "success": true,
  "message": "商品创建成功",
  "data": "新创建的商品信息"
}
```

#### 订单管理
```http
GET /api/admin/orders?page=1&limit=10&status=pending&userId=1
Authorization: Bearer <admin_token>

Response:
{
  "success": true,
  "data": {
    "orders": [
      {
        "id": "order_uuid",
        "status": "pending",
        "user": {
          "id": 1,
          "username": "user1",
          "email": "user1@example.com"
        },
        "totalPoints": 200,
        "items": [
          {
            "productId": 1,
            "productName": "智能手机",
            "quantity": 2,
            "pointsRequired": 100
          }
        ],
        "shippingAddress": "收货地址信息",
        "createdAt": "2023-12-15T10:00:00Z"
      }
    ],
    "pagination": {
      "page": 1,
      "limit": 10,
      "total": 100,
      "totalPages": 10
    }
  }
}

PUT /api/admin/orders/:id/status
Authorization: Bearer <admin_token>
Content-Type: application/json

Request Body:
{
  "status": "processing",
  "remark": "处理备注"
}

Response:
{
  "success": true,
  "message": "订单状态更新成功",
  "data": "更新后的订单信息"
}
```

#### 用户管理
```http
GET /api/admin/users?page=1&limit=10&role=user&status=active
Authorization: Bearer <admin_token>

Response:
{
  "success": true,
  "data": {
    "users": [
      {
        "id": 1,
        "username": "user1",
        "email": "user1@example.com",
        "phone": "13800138000",
        "points": 100,
        "role": "user",
        "department": "技术部",
        "position": "软件工程师",
        "status": "active",
        "createdAt": "2023-01-01T00:00:00Z"
      }
    ],
    "pagination": {
      "page": 1,
      "limit": 10,
      "total": 50,
      "totalPages": 5
    }
  }
}

PUT /api/admin/users/:id/points
Authorization: Bearer <admin_token>
Content-Type: application/json

Request Body:
{
  "pointsChange": 50,
  "type": "earn",
  "description": "活动奖励"
}

Response:
{
  "success": true,
  "message": "积分调整成功",
  "data": {
    "userId": 1,
    "pointsChange": 50,
    "currentPoints": 150
  }
}
```

#### 系统设置
```http
GET /api/admin/settings
Authorization: Bearer <admin_token>

Response:
{
  "success": true,
  "data": {
    "system": {
      "name": "企业内部福利商城",
      "version": "1.0.0",
      "logo": "logo_url"
    },
    "points": {
      "dailyCheckinPoints": 10,
      "newUserPoints": 100,
      "exchangeRate": "100积分=1元"
    },
    "announcement": {
      "enabled": true,
      "title": "系统公告",
      "content": "系统将于今晚23:00-24:00进行维护"
    }
  }
}

PUT /api/admin/settings
Authorization: Bearer <admin_token>
Content-Type: application/json

Request Body:
{
  "system.name": "企业内部福利商城",
  "points.dailyCheckinPoints": 10,
  "announcement.title": "系统公告",
  "announcement.content": "系统将于今晚23:00-24:00进行维护"
}

Response:
{
  "success": true,
  "message": "系统设置更新成功",
  "data": "更新后的设置信息"
}
```

#### 统计报表
```http
GET /api/admin/statistics/sales?startDate=2023-12-01&endDate=2023-12-31
Authorization: Bearer <admin_token>

Response:
{
  "success": true,
  "data": {
    "summary": {
      "totalSales": 1000,
      "totalPoints": 50000,
      "totalOrders": 200
    },
    "dailyStats": [
      {
        "date": "2023-12-01",
        "sales": 50,
        "points": 2500,
        "orders": 10
      }
    ],
    "topProducts": [
      {
        "id": 1,
        "name": "智能手机",
        "sales": 100,
        "points": 10000
      }
    ],
    "topCategories": [
      {
        "id": 1,
        "name": "电子产品",
        "sales": 300,
        "points": 15000
      }
    ]
  }
}
```

## 数据库设计

### 数据库设计原则

1. 使用SQLite作为数据库
2. 表名使用复数形式，字段名使用下划线命名法
3. 主键使用自增整数id，外键使用相应表名_id
4. 创建时间字段名为created_at，更新时间字段名为updated_at
5. 软删除使用deleted_at字段
6. 状态字段使用枚举值字符串
7. 金额/积分字段使用整数类型，避免浮点数精度问题

### 用户表 (users)
```sql
CREATE TABLE users (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  username TEXT UNIQUE NOT NULL,
  password TEXT NOT NULL,
  email TEXT,
  phone TEXT,
  points INTEGER DEFAULT 0,
  role TEXT DEFAULT 'user', -- 'user' or 'admin'
  department TEXT,
  position TEXT,
  avatar TEXT,
  status TEXT DEFAULT 'active', -- 'active' or 'inactive'
  last_login_at DATETIME,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  deleted_at DATETIME
);

-- 索引
CREATE UNIQUE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_role ON users(role);
CREATE INDEX idx_users_status ON users(status);
CREATE INDEX idx_users_created_at ON users(created_at);

-- 初始测试数据
INSERT INTO users (username, password, email, points, role, department, position) VALUES
('user1', '$2b$10$rOzJqQZQZQZQZQZQZQZQZOzJqQZQZQZQZQZQZQZQZQZQZQZQZQZQZQZQZQ', 'user1@example.com', 100, 'user', '技术部', '软件工程师'),
('user2', '$2b$10$rOzJqQZQZQZQZQZQZQZQZOzJqQZQZQZQZQZQZQZQZQZQZQZQZQZQZQZQZQ', 'user2@example.com', 200, 'user', '市场部', '市场专员'),
('user3', '$2b$10$rOzJqQZQZQZQZQZQZQZQZOzJqQZQZQZQZQZQZQZQZQZQZQZQZQZQZQZQZQ', 'user3@example.com', 150, 'user', '人事部', '人事专员'),
('admin', '$2b$10$rOzJqQZQZQZQZQZQZQZQZOzJqQZQZQZQZQZQZQZQZQZQZQZQZQZQZQZQZQ', 'admin@example.com', 0, 'admin', 'IT部', '系统管理员');
```

### 商品分类表 (categories)
```sql
CREATE TABLE categories (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  name TEXT NOT NULL,
  description TEXT,
  sort INTEGER DEFAULT 0,
  icon TEXT,
  status TEXT DEFAULT 'active', -- 'active' or 'inactive'
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  deleted_at DATETIME
);

-- 索引
CREATE INDEX idx_categories_sort ON categories(sort);
CREATE INDEX idx_categories_status ON categories(status);

-- 初始数据
INSERT INTO categories (name, description, sort) VALUES
('电子产品', '各类电子设备', 1),
('生活用品', '日常生活用品', 2),
('办公用品', '办公相关用品', 3),
('运动健康', '运动健康相关产品', 4),
('图书音像', '图书和音像制品', 5);
```

### 商品表 (products)
```sql
CREATE TABLE products (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  name TEXT NOT NULL,
  description TEXT,
  specifications TEXT, -- JSON格式存储规格参数
  price REAL NOT NULL,
  points_required INTEGER NOT NULL,
  stock INTEGER DEFAULT 0,
  warning_stock INTEGER DEFAULT 10,
  images TEXT, -- JSON格式存储图片URL数组
  status TEXT DEFAULT 'active', -- 'active' or 'inactive'
  category_id INTEGER,
  sales INTEGER DEFAULT 0,
  views INTEGER DEFAULT 0,
  favorites INTEGER DEFAULT 0,
  exchange_rules TEXT, -- 兑换规则
  sort INTEGER DEFAULT 0,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  deleted_at DATETIME,
  FOREIGN KEY (category_id) REFERENCES categories (id)
);

-- 索引
CREATE INDEX idx_products_category_id ON products(category_id);
CREATE INDEX idx_products_status ON products(status);
CREATE INDEX idx_products_points_required ON products(points_required);
CREATE INDEX idx_products_sales ON products(sales);
CREATE INDEX idx_products_sort ON products(sort);
CREATE INDEX idx_products_created_at ON products(created_at);

-- 初始测试数据
INSERT INTO products (name, description, price, points_required, stock, category_id, specifications, exchange_rules) VALUES
('智能手机', '高性能智能手机，拥有优秀的拍照功能和长续航', 1999.00, 100, 50, 1, '{"screen": "6.5英寸", "cpu": "八核处理器", "ram": "8GB", "storage": "128GB", "camera": "4800万像素"}', '每人限兑1台'),
('蓝牙耳机', '无线蓝牙耳机，音质清晰，佩戴舒适', 299.00, 30, 100, 1, '{"battery": "24小时续航", "connection": "蓝牙5.0", "waterproof": "IPX5防水"}', '每人限兑2个'),
('保温杯', '304不锈钢保温杯，保冷保温效果佳', 99.00, 10, 200, 2, '{"capacity": "500ml", "material": "304不锈钢", "temperature": "保温12小时，保冷24小时"}', '不限数量');
```

### 收货地址表 (addresses)
```sql
CREATE TABLE addresses (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id INTEGER NOT NULL,
  recipient_name TEXT NOT NULL,
  phone TEXT NOT NULL,
  province TEXT NOT NULL,
  city TEXT NOT NULL,
  district TEXT NOT NULL,
  address TEXT NOT NULL,
  is_default INTEGER DEFAULT 0,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  deleted_at DATETIME,
  FOREIGN KEY (user_id) REFERENCES users (id)
);

-- 索引
CREATE INDEX idx_addresses_user_id ON addresses(user_id);
CREATE INDEX idx_addresses_is_default ON addresses(is_default);
```

### 购物车表 (cart)
```sql
CREATE TABLE cart (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id INTEGER NOT NULL,
  product_id INTEGER NOT NULL,
  quantity INTEGER NOT NULL DEFAULT 1,
  is_selected INTEGER DEFAULT 1,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users (id),
  FOREIGN KEY (product_id) REFERENCES products (id),
  UNIQUE(user_id, product_id)
);

-- 索引
CREATE INDEX idx_cart_user_id ON cart(user_id);
CREATE INDEX idx_cart_product_id ON cart(product_id);
CREATE INDEX idx_cart_is_selected ON cart(is_selected);
```

### 订单表 (orders)
```sql
CREATE TABLE orders (
  id TEXT PRIMARY KEY, -- UUID
  user_id INTEGER NOT NULL,
  total_points INTEGER NOT NULL,
  status TEXT DEFAULT 'pending', -- 'pending', 'processing', 'shipped', 'completed', 'cancelled'
  shipping_address TEXT NOT NULL, -- JSON格式存储地址信息
  remark TEXT,
  cancelled_at DATETIME,
  completed_at DATETIME,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  deleted_at DATETIME,
  FOREIGN KEY (user_id) REFERENCES users (id)
);

-- 索引
CREATE INDEX idx_orders_user_id ON orders(user_id);
CREATE INDEX idx_orders_status ON orders(status);
CREATE INDEX idx_orders_created_at ON orders(created_at);
CREATE INDEX idx_orders_cancelled_at ON orders(cancelled_at);
CREATE INDEX idx_orders_completed_at ON orders(completed_at);
```

### 订单明细表 (order_items)
```sql
CREATE TABLE order_items (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  order_id TEXT NOT NULL,
  product_id INTEGER NOT NULL,
  product_name TEXT NOT NULL,
  product_image TEXT,
  quantity INTEGER NOT NULL,
  points_required INTEGER NOT NULL,
  total_points INTEGER NOT NULL,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (order_id) REFERENCES orders (id),
  FOREIGN KEY (product_id) REFERENCES products (id)
);

-- 索引
CREATE INDEX idx_order_items_order_id ON order_items(order_id);
CREATE INDEX idx_order_items_product_id ON order_items(product_id);
```

### 积分记录表 (points_history)
```sql
CREATE TABLE points_history (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id INTEGER NOT NULL,
  points_change INTEGER NOT NULL,
  type TEXT NOT NULL, -- 'earn', 'spend'
  description TEXT,
  reference_id TEXT, -- 订单ID等关联ID
  reference_type TEXT, -- 'order', 'checkin', 'admin_adjust'等
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users (id)
);

-- 索引
CREATE INDEX idx_points_history_user_id ON points_history(user_id);
CREATE INDEX idx_points_history_type ON points_history(type);
CREATE INDEX idx_points_history_created_at ON points_history(created_at);
```

### 商品收藏表 (favorites)
```sql
CREATE TABLE favorites (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id INTEGER NOT NULL,
  product_id INTEGER NOT NULL,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users (id),
  FOREIGN KEY (product_id) REFERENCES products (id),
  UNIQUE(user_id, product_id)
);

-- 索引
CREATE INDEX idx_favorites_user_id ON favorites(user_id);
CREATE INDEX idx_favorites_product_id ON favorites(product_id);
```

### 系统配置表 (system_configs)
```sql
CREATE TABLE system_configs (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  key TEXT UNIQUE NOT NULL,
  value TEXT,
  description TEXT,
  type TEXT DEFAULT 'string', -- 'string', 'number', 'boolean', 'json'
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE UNIQUE INDEX idx_system_configs_key ON system_configs(key);

-- 初始配置数据
INSERT INTO system_configs (key, value, description, type) VALUES
('system.name', '企业内部福利商城', '系统名称', 'string'),
('system.logo', '', '系统Logo', 'string'),
('points.daily_checkin', '10', '每日签到积分', 'number'),
('points.new_user', '100', '新用户注册积分', 'number'),
('announcement.enabled', 'false', '是否启用公告', 'boolean'),
('announcement.title', '', '公告标题', 'string'),
('announcement.content', '', '公告内容', 'string');
```

### 用户签到表 (checkins)
```sql
CREATE TABLE checkins (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id INTEGER NOT NULL,
  checkin_date DATE NOT NULL, -- YYYY-MM-DD格式
  points_earned INTEGER NOT NULL DEFAULT 10,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users (id),
  UNIQUE(user_id, checkin_date)
);

-- 索引
CREATE INDEX idx_checkins_user_id ON checkins(user_id);
CREATE INDEX idx_checkins_checkin_date ON checkins(checkin_date);
```

### 数据库视图

#### 用户积分视图
```sql
CREATE VIEW user_points_view AS
SELECT 
  u.id,
  u.username,
  u.points AS current_points,
  COALESCE(earn.total_earned, 0) AS total_earned,
  COALESCE(spend.total_spent, 0) AS total_spent
FROM users u
LEFT JOIN (
  SELECT user_id, SUM(points_change) AS total_earned
  FROM points_history
  WHERE type = 'earn'
  GROUP BY user_id
) earn ON u.id = earn.user_id
LEFT JOIN (
  SELECT user_id, SUM(-points_change) AS total_spent
  FROM points_history
  WHERE type = 'spend'
  GROUP BY user_id
) spend ON u.id = spend.user_id;
```

#### 商品统计视图
```sql
CREATE VIEW product_stats_view AS
SELECT 
  p.id,
  p.name,
  p.points_required,
  p.stock,
  p.sales,
  p.views,
  p.favorites,
  c.name AS category_name,
  COALESCE(oi.total_orders, 0) AS total_orders
FROM products p
LEFT JOIN categories c ON p.category_id = c.id
LEFT JOIN (
  SELECT product_id, COUNT(DISTINCT order_id) AS total_orders
  FROM order_items
  GROUP BY product_id
) oi ON p.id = oi.product_id;
```

## 数据库操作规范

1. **查询优化**：
   - 使用索引优化查询性能
   - 避免SELECT *，只查询需要的字段
   - 使用LIMIT限制查询结果数量
   - 使用EXISTS代替IN，提高查询效率

2. **事务处理**：
   - 涉及多个表的操作使用事务
   - 订单创建时使用事务确保数据一致性
   - 积分变动使用事务保证准确性

3. **数据安全**：
   - 用户密码使用bcrypt加密存储
   - 敏感操作记录操作日志
   - 重要数据操作添加权限检查

4. **性能优化**：
   - 定期清理软删除的数据
   - 对大表考虑分表策略
   - 使用缓存减轻数据库压力

5. **备份策略**：
   - 定期备份数据库文件
   - 重要操作前进行手动备份
   - 保留多个备份版本