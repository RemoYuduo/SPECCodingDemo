# 企业内部福利商城 - 后端架构信息

|- **版本**: v1.1.0
|- **更新日期**: 2025-12-16
|- **技术栈**: Node.js + Express.js + SQLite + JWT + bcryptjs
|- **状态**: 开发中

## 目录结构

```
backend/
├── src/                        # 源代码目录
│   ├── controllers/            # 控制器层
│   │   ├── authController.js  # 认证控制器(已实现)
│   │   ├── adminController.js # 管理员控制器(已实现)
│   │   ├── cartController.js  # 购物车控制器(已实现)
│   │   └── productController.js # 商品控制器
│   ├── services/              # 业务逻辑层
│   │   ├── cartService.js     # 购物车服务(已实现)
│   │   └── productService.js  # 商品服务(已实现)
│   ├── models/                # 数据模型层
│   │   ├── Cart.js            # 购物车模型(已实现)
│   │   ├── Category.js        # 商品分类模型(已实现)
│   │   └── Product.js         # 商品模型(已实现)
│   ├── routes/                # 路由层
│   │   ├── auth.js            # 认证路由(已实现)
│   │   ├── admin.js           # 管理员路由(已实现)
│   │   ├── cart.js            # 购物车路由(已实现)
│   │   ├── health.js          # 健康检查路由(已实现)
│   │   ├── product.js         # 商品路由
│   │   └── user.js            # 用户路由(已实现)
│   ├── middleware/            # 中间件
│   │   ├── auth.js            # 认证中间件(已实现)
│   │   └── error.js           # 错误处理中间件(已实现)
│   ├── config/                # 配置文件
│   │   ├── app.js             # 应用配置(已实现)
│   │   └── database.js        # 数据库配置(已实现)
│   ├── database/              # 数据库相关
│   │   └── init.js            # 数据库初始化(已实现)
│   └── utils/                 # 工具函数
│       ├── response.js        # 响应格式化工具(已实现)
│       └── fileUpload.js      # 文件上传工具(已实现)
├── database/                  # 数据库文件存储
│   └── mall.db               # SQLite数据库文件
├── test/                      # 测试目录
│   ├── cart-api.js         # 购物车API测试(已实现)
│   └── product-api.js      # 商品API测试(已实现)
├── uploads/                   # 上传文件存储
│   └── products/             # 商品图片存储(已实现)
├── .env                       # 环境变量配置
├── init-db.js              # 数据库初始化脚本(已实现)
├── package.json               # 依赖配置(已实现)
└── server.js                  # 服务器入口文件(已实现)
```

## 模块外部特性

### 1. 认证模块 (auth)
- **authController.js**: 认证控制器
  - 功能: 处理登录、登出等认证请求
  - 状态: 已实现基础功能
  - 依赖: auth.js(middleware)

- **authService.js**: 认证服务
  - 功能: 用户身份验证、JWT令牌生成与验证
  - 状态: 已实现基础功能
  - 依赖: User.js(model), bcryptjs, jsonwebtoken

- **auth.js**: 认证路由
  - 功能: 定义登录、注册、登出等认证相关路由
  - 状态: 已实现基础功能
  - 依赖: authController.js, auth.js(middleware)

### 2. 用户模块 (user)
- **userController.js**: 用户控制器
  - 功能: 处理用户信息获取、更新、积分查询等请求
  - 状态: 已实现基础功能
  - 依赖: auth.js(middleware)

- **user.js**: 用户路由
  - 功能: 定义用户信息、积分、地址等相关路由
  - 状态: 已实现基础功能
  - 依赖: userController.js, auth.js(middleware)

### 3. 购物车模块 (cart)
- **cartController.js**: 购物车控制器
  - 功能: 处理购物车商品增删改查、数量调整、选中状态更新等请求
  - 状态: 已实现
  - 依赖: cartService.js, authenticateToken(middleware)

- **cartService.js**: 购物车服务
  - 功能: 购物车商品管理、数量调整、选中状态管理、积分统计
  - 状态: 已实现
  - 依赖: Cart.js(model)

- **cart.js**: 购物车路由
  - 功能: 定义购物车相关路由
  - 状态: 已实现
  - 依赖: cartController.js, authenticateToken(middleware)
  - 主要路由: 
    - GET /cart - 获取购物车列表
    - POST /cart - 添加商品到购物车
    - PUT /cart/:id - 更新购物车商品数量
    - DELETE /cart/:id - 删除购物车商品
    - PUT /cart/batch-update-selection - 批量更新选中状态
    - DELETE /cart/batch-remove - 批量删除购物车商品

- **Cart.js**: 购物车模型
  - 功能: 购物车数据结构定义、购物车相关数据操作
  - 状态: 已实现
  - 依赖: database.js(config)
  - 主要方法:
    - getCartByUserId - 获取用户购物车
    - addToCart - 添加商品到购物车
    - updateQuantity - 更新商品数量
    - updateSelectedStatus - 更新选中状态
    - removeFromCart - 删除购物车项

### 4. 商品模块 (product)
- **productController.js**: 商品控制器
  - 功能: 处理商品列表、详情、搜索等请求
  - 状态: 已实现基础功能
  - 依赖: productService.js

- **productService.js**: 商品服务
  - 功能: 商品信息管理、分类管理、库存管理、商品搜索
  - 状态: 已实现
  - 依赖: Product.js(model), Category.js(model)

- **product.js**: 商品路由
  - 功能: 定义商品列表、详情、搜索等相关路由
  - 状态: 已实现
  - 依赖: productController.js

### 4. 管理员模块 (admin)
- **adminController.js**: 管理员控制器
  - 功能: 处理管理员相关请求、系统管理、商品管理、图片上传、商品状态更新、库存调整
  - 状态: 已实现
  - 依赖: productService.js, auth.js(middleware)
  - 新增方法: updateProductStatus(商品状态更新), updateProductStock(商品库存调整)

- **adminService.js**: 管理员服务
  - 功能: 商品管理、订单管理、用户管理、系统设置
  - 状态: 已实现基础功能
  - 依赖: 所有模型

- **admin.js**: 管理员路由
  - 功能: 定义管理员相关路由
  - 状态: 已实现
  - 依赖: adminController.js, auth.js(middleware)
  - 新增路由: PUT /products/:id/status(商品状态更新), PUT /products/:id/stock(商品库存调整)

### 5. 数据模型 (models)
- **Product.js**: 商品模型
  - 功能: 商品数据结构定义、商品相关数据操作
  - 状态: 已实现
  - 依赖: database.js

- **Category.js**: 商品分类模型
  - 功能: 商品分类数据结构定义、分类相关数据操作
  - 状态: 已实现
  - 依赖: database.js

### 6. 中间件 (middleware)
- **auth.js**: 认证中间件
  - 功能: JWT令牌验证、用户身份识别、权限控制
  - 状态: 已实现基础功能
  - 依赖: jsonwebtoken, User.js(model)

- **error.js**: 错误处理中间件
  - 功能: 统一错误处理、错误响应格式化
  - 状态: 已实现基础功能
  - 依赖: 无

### 7. 配置模块 (config)
- **database.js**: 数据库配置
  - 功能: SQLite数据库连接、连接池管理、数据库配置
  - 状态: 已实现基础功能
  - 依赖: sqlite3

- **app.js**: 应用配置
  - 功能: 应用全局配置、环境变量管理、CORS配置
  - 状态: 已实现基础功能
  - 依赖: dotenv

### 8. 数据库模块 (database)
- **init.js**: 数据库初始化
  - 功能: 数据库表创建、初始数据插入、数据库版本管理
  - 状态: 已实现基础功能
  - 依赖: database.js(config)

### 9. 工具函数 (utils)
- **response.js**: 响应格式化工具
  - 功能: 统一响应格式、成功响应、错误响应
  - 状态: 已实现基础功能
  - 依赖: 无

- **fileUpload.js**: 文件上传工具
  - 功能: 文件上传、图片处理、文件存储、URL生成
  - 状态: 已实现
  - 图片处理: 使用Sharp进行图片压缩
  - URL格式: /uploads/products/xxx.jpg
  - 依赖: multer, sharp

### 10. 健康检查模块 (health)
- **health.js**: 健康检查路由
  - 功能: 服务健康检查、数据库状态检查
  - 状态: 已实现基础功能
  - 依赖: database.js(config)

### 11. 服务器入口 (server.js)
- **server.js**: 服务器入口文件
  - 功能: Express服务器配置、路由注册、中间件应用、错误处理、数据库初始化
  - 状态: 已实现基础功能
  - 静态文件服务: 已配置/uploads路径
  - 依赖: 所有模块

### 12. 测试模块 (test)
- **product-api.js**: 商品API测试
  - 功能: 测试商品相关API接口
  - 状态: 已实现
  - 依赖: 无